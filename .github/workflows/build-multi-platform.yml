name: Build Multi-Platform App

on:
  push:
    branches:
      - dev
      - master

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Electron app (deb)
        run: npm run electron:build:deb

      - name: Build Electron app (AppImage)
        run: npm run electron:build:appimage

      - name: Upload deb artifact (dev branch)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: k-linux-deb
          path: build/*.deb
          retention-days: 30

      - name: Upload AppImage artifact (dev branch)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: k-linux-appimage
          path: build/*.AppImage
          retention-days: 30

      - name: Upload Linux artifacts for release (master branch)
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-artifacts
          path: |
            build/*.deb
            build/*.AppImage
          retention-days: 90

      - name: Upload build summary
        if: always()
        run: |
          echo "## Linux Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh build/*.deb build/*.AppImage 2>/dev/null || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Electron app (Windows)
        run: npm run electron:build:win

      - name: Upload Windows installer artifact (dev branch)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: k-windows-x64
          path: build/*.exe
          retention-days: 30

      - name: Upload Windows artifacts for release (master branch)
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifacts
          path: build/*.exe
          retention-days: 90

      - name: Upload build summary
        if: always()
        shell: bash
        run: |
          echo "## Windows Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh build/*.exe 2>/dev/null || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY

  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Setup Android signing
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > $RUNNER_TEMP/release.keystore
          echo "Keystore decoded to temporary location"

      - name: Build Android APK (Release - Signed)
        env:
          KEYSTORE_FILE: ${{ runner.temp }}/release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK artifact (dev branch)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: k-android-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Upload Android artifacts for release (master branch)
        if: github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: android-release-artifacts
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Upload build summary
        if: always()
        run: |
          echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh android/app/build/outputs/apk/release/*.apk 2>/dev/null || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY

  create-release:
    needs: [build-linux, build-windows, build-android]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-release-artifacts
          path: ./release-artifacts

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release-artifacts
          path: ./release-artifacts

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release-artifacts
          path: ./release-artifacts

      - name: Read release notes
        id: release-notes
        run: |
          NOTES=$(cat .github/workflows/release-notes.md)
          echo "notes<<HEREDOC_DELIMITER" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "HEREDOC_DELIMITER" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package-version.outputs.version }}
          name: Release v${{ steps.package-version.outputs.version }}
          body: |
            ${{ steps.release-notes.outputs.notes }}

            ---

            ### Downloads

            #### Linux
            - **Debian/Ubuntu installer (.deb)**: Install with `sudo dpkg -i K-${{ steps.package-version.outputs.version }}-linux-x64.deb`
            - **Debian/Ubuntu portable (.AppImage)**: Make executable with `chmod +x K-${{ steps.package-version.outputs.version }}-linux-x64.AppImage` and run

            #### Windows
            - **Windows portable (.exe)**: Run `K-${{ steps.package-version.outputs.version }}-windows-x64.exe` directly (no installation required)

            #### Android
            - **Android app (.apk)**: Download and install the APK file. You may need to enable "Install from Unknown Sources" in your Android settings.

                **APK Signature Verification:**

                To verify the APK authenticity, check that the SHA-256 fingerprint matches:
                ```
                2E:E0:D9:FF:5C:8A:12:A7:0B:F4:BB:9D:41:9E:8D:F3:76:20:37:B1:76:66:BF:20:92:06:4F:BA:5D:F3:D7:C2
                ```

                Verify downloaded APK with:
                ```bash
                apksigner verify --print-certs K-*.apk
                ```

          files: |
            ./release-artifacts/*.deb
            ./release-artifacts/*.AppImage
            ./release-artifacts/*.exe
            ./release-artifacts/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
